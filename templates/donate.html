{% extends 'base.html' %}
{% load static %}

{% block title %}Donate to GYWAN - Support Girls' Empowerment{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/donation.css' %}">
<style>
/* Enhanced donation styles */
.donation-main {
    background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
    padding: 60px 0;
    min-height: 100vh;
}

.donation-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 40px;
    max-width: 1200px;
    margin: 0 auto;
}

.donation-form-container {
    background: white;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 8px 32px rgba(136, 36, 199, 0.08);
    border: 1px solid #f0f0f0;
}

.donation-summary {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(136, 36, 199, 0.08);
    border: 1px solid #f0f0f0;
    height: fit-content;
    position: sticky;
    top: 120px;
}

.amount-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.amount-option {
    background: white;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    padding: 16px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    position: relative;
    overflow: hidden;
}

.amount-option:hover {
    border-color: #8824C7;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(136, 36, 199, 0.15);
}

.amount-option.selected {
    background: linear-gradient(135deg, #8824C7, #BA4BFF);
    border-color: #8824C7;
    color: white;
    transform: scale(1.05);
}

.amount-option .amount {
    display: block;
    font-size: 18px;
    font-weight: 700;
}

.amount-option .impact {
    display: block;
    font-size: 12px;
    opacity: 0.8;
    margin-top: 4px;
}

.custom-amount {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9ff;
    border-radius: 12px;
    border: 2px solid #e1e5e9;
    transition: border-color 0.3s ease;
}

.custom-amount:focus-within {
    border-color: #8824C7;
}

.amount-input {
    position: relative;
    margin-top: 8px;
}

.currency {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-weight: 600;
    color: #666;
}

#custom-amount {
    width: 100%;
    padding: 12px 12px 12px 50px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    transition: border-color 0.3s ease;
}

#custom-amount:focus {
    outline: none;
    border-color: #8824C7;
}

.frequency-options, .payment-method-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.frequency-option, .payment-method-option {
    display: flex;
    align-items: center;
    padding: 16px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.frequency-option:hover, .payment-method-option:hover {
    border-color: #8824C7;
    background: #f8f9ff;
}

.frequency-option input:checked + .radio-custom + .option-content,
.payment-method-option input:checked + .radio-custom + .option-title {
    color: #8824C7;
}

.frequency-option input:checked,
.payment-method-option input:checked {
    & ~ * {
        border-color: #8824C7;
    }
}

.frequency-option:has(input:checked),
.payment-method-option:has(input:checked) {
    border-color: #8824C7;
    background: #f8f9ff;
}

.radio-custom {
    width: 20px;
    height: 20px;
    border: 2px solid #ddd;
    border-radius: 50%;
    margin-right: 12px;
    position: relative;
    transition: all 0.3s ease;
}

.frequency-option input:checked + .radio-custom,
.payment-method-option input:checked + .radio-custom {
    border-color: #8824C7;
    background: #8824C7;
}

.frequency-option input:checked + .radio-custom::after,
.payment-method-option input:checked + .radio-custom::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
}

.option-content {
    flex: 1;
}

.option-title {
    display: block;
    font-weight: 600;
    margin-bottom: 4px;
}

.option-desc {
    display: block;
    font-size: 14px;
    color: #666;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #8824C7;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: 500;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #ddd;
    border-radius: 4px;
    margin-right: 8px;
    position: relative;
    transition: all 0.3s ease;
}

input[type="checkbox"]:checked + .checkmark {
    background: #8824C7;
    border-color: #8824C7;
}

input[type="checkbox"]:checked + .checkmark::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
}

.donate-button {
    width: 100%;
    background: linear-gradient(135deg, #8824C7, #BA4BFF);
    color: white;
    border: none;
    padding: 18px 24px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 30px;
    position: relative;
    overflow: hidden;
}

.donate-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(136, 36, 199, 0.3);
}

.donate-button:active {
    transform: translateY(0);
}

.donate-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.summary-header h3 {
    color: #333;
    margin-bottom: 20px;
    font-size: 20px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
}

.summary-item.total {
    border-bottom: none;
    border-top: 2px solid #8824C7;
    font-size: 18px;
    font-weight: 700;
    color: #8824C7;
    margin-top: 10px;
    padding-top: 15px;
}

.impact-preview {
    background: #f8f9ff;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    border-left: 4px solid #8824C7;
}

.impact-preview h4 {
    color: #8824C7;
    margin-bottom: 10px;
}

.trust-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
}

.trust-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
}

.trust-item i {
    color: #8824C7;
    width: 16px;
}

.security-badges {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
}

.security-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
}

.security-badge i {
    font-size: 24px;
    color: #8824C7;
}

.loading-spinner {
    width: 20px;
    height: 20px;
}

.spinner {
    width: 100%;
    height: 100%;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .donation-layout {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .donation-summary {
        position: static;
        order: -1;
    }
    
    .amount-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Hide all sections by default, show based on selection */
.payment-section {
    display: none;
}

.payment-section.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="donate-hero" data-aos="fade-up">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Your Support Changes Lives</h1>
            <p class="hero-subtitle">Every donation empowers girls and young women to become confident leaders and changemakers.</p>
            <div class="hero-stats">
                <div class="stat">
                    <span class="stat-number">10,000+</span>
                    <span class="stat-label">Girls Empowered</span>
                </div>
                <div class="stat">
                    <span class="stat-number">50+</span>
                    <span class="stat-label">Communities Reached</span>
                </div>
                <div class="stat">
                    <span class="stat-number">95%</span>
                    <span class="stat-label">Success Rate</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Donation Form -->
<section class="donation-main">
    <div class="container">
        <div class="donation-layout">
            <!-- Donation Form -->
            <div class="donation-form-container">
                <form id="donation-form" method="post" class="donation-form">
                    {% csrf_token %}
                
                    <!-- Amount Selection -->
                    <div class="form-section">
                        <h2>Select Your Donation Amount</h2>
                        <div class="amount-options">
                            <div class="amount-grid">
                                <button type="button" class="amount-option" data-amount="50">
                                    <span class="amount">SLE50</span>
                                    <span class="impact">Provides school supplies for 2 girls</span>
                                </button>
                                <button type="button" class="amount-option" data-amount="100">
                                    <span class="amount">SLE100</span>
                                    <span class="impact">Funds a leadership workshop</span>
                                </button>
                                <button type="button" class="amount-option" data-amount="250">
                                    <span class="amount">SLE250</span>
                                    <span class="impact">Supports mentorship for 5 girls</span>
                                </button>
                                <button type="button" class="amount-option" data-amount="500">
                                    <span class="amount">SLE500</span>
                                    <span class="impact">Provides career training program</span>
                                </button>
                                <button type="button" class="amount-option" data-amount="1000">
                                    <span class="amount">SLE1000</span>
                                    <span class="impact">Sponsors a girl for full year</span>
                                </button>
                                <button type="button" class="amount-option" data-amount="2500">
                                    <span class="amount">SLE2500</span>
                                    <span class="impact">Funds community outreach program</span>
                                </button>
                            </div>
                            <div class="custom-amount">
                                <label for="custom-amount">Other amount</label>
                                <div class="amount-input">
                                    <span class="currency">SLE</span>
                                    <input type="number" id="custom-amount" min="1" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Frequency Selection -->
                    <div class="form-section">
                        <h2>Donation Frequency</h2>
                        <div class="frequency-options">
                            <label class="frequency-option">
                                <input type="radio" name="frequency" value="one-time" checked>
                                <span class="radio-custom"></span>
                                <div class="option-content">
                                    <span class="option-title">One-time donation</span>
                                    <span class="option-desc">Make a single donation today</span>
                                </div>
                            </label>
                            <label class="frequency-option">
                                <input type="radio" name="frequency" value="monthly">
                                <span class="radio-custom"></span>
                                <div class="option-content">
                                    <span class="option-title">Monthly donation</span>
                                    <span class="option-desc">Support girls every month (cancel anytime)</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h2>Your Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="donor-name">Full Name *</label>
                                <input type="text" id="donor-name" name="donor_name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="donor-email">Email Address *</label>
                                <input type="email" id="donor-email" name="donor_email" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="donor-message">Message (Optional)</label>
                            <textarea id="donor-message" name="message" class="form-control" rows="3" placeholder="Share why you're supporting GYWAN..."></textarea>
                        </div>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="anonymous" name="is_anonymous">
                                <span class="checkmark"></span>
                                Make this donation anonymous
                            </label>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="form-section">
                        <h2>Payment Method</h2>
                        <div class="payment-method-options">
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="card" checked>
                                <span class="radio-custom"></span>
                                <span class="option-title">Credit/Debit Card (Visa, Mastercard)</span>
                            </label>
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="mobile">
                                <span class="radio-custom"></span>
                                <span class="option-title">Mobile Money (Afrimoney, Orange Money)</span>
                            </label>
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="bank">
                                <span class="radio-custom"></span>
                                <span class="option-title">Bank Transfer (Sierra Leone Banks)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Card Payment Section -->
                    <div class="form-section payment-section active" id="card-section">
                        <h2>Card Payment</h2>
                        <div class="payment-container">
                            <div id="card-element" class="card-element form-control">
                                <!-- Stripe Elements will create form elements here -->
                            </div>
                            <div id="card-errors" class="card-errors"></div>
                        </div>
                    </div>

                    <!-- Mobile Money Section -->
                    <div class="form-section payment-section" id="mobile-section">
                        <h2>Mobile Money Payment</h2>
                        <div class="form-group">
                            <label for="mobile-provider">Select Provider</label>
                            <select id="mobile-provider" name="mobile_provider" class="form-control">
                                <option value="">Choose your provider</option>
                                <option value="afrimoney">Afrimoney</option>
                                <option value="orangemoney">Orange Money</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mobile-number">Mobile Number</label>
                            <input type="tel" id="mobile-number" name="mobile_number" class="form-control" placeholder="e.g. 232XXXXXXXXX">
                        </div>
                        <div class="mobile-instructions">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <p>You will receive an SMS shortly after submitting with instructions to complete your payment via your selected mobile money provider.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Transfer Section -->
                    <div class="form-section payment-section" id="bank-section">
                        <h2>Bank Transfer Payment</h2>
                        <div class="form-group">
                            <label for="bank-name">Select Your Bank</label>
                            <select id="bank-name" name="bank_name" class="form-control">
                                <option value="">Select a bank</option>
                                <option value="ecobank">Ecobank Sierra Leone</option>
                                <option value="rokel">Rokel Commercial Bank</option>
                                <option value="zenith">Zenith Bank</option>
                                <option value="uba">United Bank for Africa (UBA)</option>
                                <option value="gtbank">Guaranty Trust Bank (GTBank)</option>
                                <option value="standardchartered">Standard Chartered Bank</option>
                                <option value="access">Access Bank</option>
                            </select>
                        </div>
                        <div class="bank-instructions">
                            <div class="alert alert-info">
                                <i class="fas fa-university"></i>
                                <p>After submitting, you will receive detailed bank transfer instructions via email.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Trust & Security -->
                    <div class="trust-section">
                        <div class="security-badges">
                            <div class="security-badge">
                                <i class="fas fa-shield-alt"></i>
                                <span>SSL Secure</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-lock"></i>
                                <span>256-bit Encrypted</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-certificate"></i>
                                <span>PCI Compliant</span>
                            </div>
                        </div>
                        <div class="tax-info">
                            <p><small><strong>Tax Deductible:</strong> GYWAN is a registered non-profit. Your donation is tax-deductible to the extent allowed by law. You will receive a receipt via email.</small></p>
                        </div>
                    </div>
                    
                    <button type="submit" class="donate-button" id="donate-btn">
                        <span class="button-text">Complete Donation</span>
                        <span class="button-amount">SLE<span id="selected-amount">0</span></span>
                        <div class="loading-spinner" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </button>
                </form>
            </div>
            
            <!-- Donation Summary -->
            <div class="donation-summary">
                <div class="summary-header">
                    <h3>Donation Summary</h3>
                </div>
                <div class="summary-content">
                    <div class="summary-item">
                        <span>Amount:</span>
                        <span id="summary-amount">SLE0</span>
                    </div>
                    <div class="summary-item">
                        <span>Frequency:</span>
                        <span id="summary-frequency">One-time</span>
                    </div>
                    <div class="summary-item total">
                        <span>Total:</span>
                        <span id="summary-total">SLE0</span>
                    </div>
                </div>
                <div class="impact-preview">
                    <h4>Your Impact</h4>
                    <p id="impact-description">Select an amount to see your impact</p>
                </div>
                <div class="trust-info">
                    <div class="trust-item">
                        <i class="fas fa-heart"></i>
                        <span>100% goes to programs</span>
                    </div>
                    <div class="trust-item">
                        <i class="fas fa-receipt"></i>
                        <span>Tax receipt emailed</span>
                    </div>
                    <div class="trust-item">
                        <i class="fas fa-handshake"></i>
                        <span>Secure & trusted</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Impact Stories -->
<section class="impact-stories" data-aos="fade-up">
    <div class="container">
        <div class="section-header">
            <h2>Real Impact Stories</h2>
            <p>See how your donations are changing lives</p>
        </div>
        <div class="stories-grid">
            {% for story in impact_stories %}
            <div class="story-card">
                <div class="story-image">
                    <img src="{{ story.image.url }}" alt="{{ story.title }}">
                </div>
                <div class="story-content">
                    <h3>{{ story.title }}</h3>
                    <p>{{ story.quote }}</p>
                    <span class="story-location">{{ story.location }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Other Ways to Support -->
<section class="other-ways" data-aos="fade-up">
    <div class="container">
        <div class="section-header">
            <h2>Other Ways to Support</h2>
            <p>Multiple ways to make a difference</p>
        </div>
        <div class="ways-grid">
            <div class="way-card">
                <div class="way-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <h3>Mail a Check</h3>
                <p>Send your donation to:<br>GYWAN, 1 Sillicon Hills, Mile 91, Sierra Leone</p>
            </div>
            <div class="way-card">
                <div class="way-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <h3>Call Us</h3>
                <p>Donate by phone:<br><strong>+232 77491399</strong></p>
            </div>
            <div class="way-card">
                <div class="way-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>Volunteer</h3>
                <p>Share your time and skills to directly impact girls' lives</p>
                <a href="{% url 'contact' %}" class="btn btn-outline">Get Involved</a>
            </div>
            <div class="way-card">
                <div class="way-icon">
                    <i class="fas fa-building"></i>
                </div>
                <h3>Corporate Partnership</h3>
                <p>Partner with us for workplace programs and CSR initiatives</p>
                <a href="{% url 'contact' %}" class="btn btn-outline">Learn More</a>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
window.STRIPE_PUBLIC_KEY = "{{ STRIPE_PUBLIC_KEY }}";

document.addEventListener('DOMContentLoaded', function() {
    // Amount selection logic
    const amountOptions = document.querySelectorAll('.amount-option');
    const customAmountInput = document.getElementById('custom-amount');
    const selectedAmountSpan = document.getElementById('selected-amount');
    const summaryAmount = document.getElementById('summary-amount');
    const summaryTotal = document.getElementById('summary-total');
    const impactDescription = document.getElementById('impact-description');
    
    let selectedAmount = 0;
    
    const impactMessages = {
        50: "Provides school supplies for 2 girls for a month",
        100: "Funds a leadership workshop for 10 girls",
        250: "Supports mentorship program for 5 girls",
        500: "Provides career training for a group of girls",
        1000: "Sponsors a girl's education for a full year",
        2500: "Funds a complete community outreach program"
    };
    
    function updateAmount(amount) {
        selectedAmount = amount;
        selectedAmountSpan.textContent = amount;
        summaryAmount.textContent = `SLE${amount}`;
        summaryTotal.textContent = `SLE${amount}`;
        
        // Update impact message
        const message = impactMessages[amount] || `Your donation of SLE${amount} will make a real difference in girls' lives`;
        impactDescription.textContent = message;
        
        // Update button state
        const donateBtn = document.getElementById('donate-btn');
        donateBtn.disabled = amount <= 0;
    }
    
    // Handle preset amount selection
    amountOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            amountOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            customAmountInput.value = '';
            updateAmount(parseInt(this.dataset.amount));
        });
    });
    
    // Handle custom amount input
    customAmountInput.addEventListener('input', function() {
        amountOptions.forEach(opt => opt.classList.remove('selected'));
        const amount = parseFloat(this.value) || 0;
        updateAmount(amount);
    });
    
    // Frequency selection logic
    const frequencyOptions = document.querySelectorAll('input[name="frequency"]');
    const summaryFrequency = document.getElementById('summary-frequency');
    
    frequencyOptions.forEach(option => {
        option.addEventListener('change', function() {
            summaryFrequency.textContent = this.value === 'monthly' ? 'Monthly' : 'One-time';
        });
    });
    
    // Payment method switching
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const paymentSections = document.querySelectorAll('.payment-section');
    
    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            paymentSections.forEach(section => section.classList.remove('active'));
            document.getElementById(`${this.value}-section`).classList.add('active');
        });
    });
    
    // Form validation and submission
    const donationForm = document.getElementById('donation-form');
    const donateBtn = document.getElementById('donate-btn');
    
    donationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        if (!validateForm()) {
            return;
        }
        
        // Show loading state
        const buttonText = donateBtn.querySelector('.button-text');
        const loadingSpinner = donateBtn.querySelector('.loading-spinner');
        
        donateBtn.disabled = true;
        buttonText.textContent = 'Processing...';
        loadingSpinner.style.display = 'block';
        
        // Get selected payment method
        const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        // Process payment based on method
        if (selectedPaymentMethod === 'card') {
            processCardPayment();
        } else if (selectedPaymentMethod === 'mobile') {
            processMobilePayment();
        } else if (selectedPaymentMethod === 'bank') {
            processBankTransfer();
        }
    });
    
    function validateForm() {
        const name = document.getElementById('donor-name').value.trim();
        const email = document.getElementById('donor-email').value.trim();
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        if (!name) {
            showError('Please enter your full name');
            return false;
        }
        
        if (!email || !isValidEmail(email)) {
            showError('Please enter a valid email address');
            return false;
        }
        
        if (selectedAmount <= 0) {
            showError('Please select a donation amount');
            return false;
        }
        
        // Additional validation based on payment method
        if (paymentMethod === 'mobile') {
            const provider = document.getElementById('mobile-provider').value;
            const number = document.getElementById('mobile-number').value.trim();
            
            if (!provider) {
                showError('Please select a mobile money provider');
                return false;
            }
            
            if (!number) {
                showError('Please enter your mobile number');
                return false;
            }
        } else if (paymentMethod === 'bank') {
            const bank = document.getElementById('bank-name').value;
            
            if (!bank) {
                showError('Please select your bank');
                return false;
            }
        }
        
        return true;
    }
    
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    function showError(message) {
        // Create or update error message
        let errorDiv = document.querySelector('.form-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'form-error';
            errorDiv.style.cssText = `
                background: #fee;
                color: #c33;
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 20px;
                border: 1px solid #fcc;
                font-weight: 600;
            `;
            donationForm.insertBefore(errorDiv, donateBtn);
        }
        errorDiv.textContent = message;
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Reset button state
        resetButtonState();
    }
    
    function showSuccess(message) {
        // Create success message
        const successDiv = document.createElement('div');
        successDiv.className = 'form-success';
        successDiv.style.cssText = `
            background: #efe;
            color: #3a3;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #cfc;
            font-weight: 600;
            text-align: center;
        `;
        successDiv.innerHTML = `
            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
            ${message}
        `;
        
        // Replace form with success message
        donationForm.style.display = 'none';
        donationForm.parentNode.insertBefore(successDiv, donationForm);
    }
    
    function resetButtonState() {
        donateBtn.disabled = false;
        donateBtn.querySelector('.button-text').textContent = 'Complete Donation';
        donateBtn.querySelector('.loading-spinner').style.display = 'none';
    }
    
    async function processCardPayment() {
        try {
            // Initialize Stripe (you'll need to implement Stripe integration)
            if (typeof Stripe === 'undefined') {
                throw new Error('Stripe is not loaded');
            }
            
            const stripe = Stripe(window.STRIPE_PUBLIC_KEY);
            
            // Create payment intent on your server
            const response = await fetch('/create-payment-intent/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    amount: selectedAmount * 100, // Convert to cents
                    currency: 'sll',
                    donor_name: document.getElementById('donor-name').value,
                    donor_email: document.getElementById('donor-email').value,
                    frequency: document.querySelector('input[name="frequency"]:checked').value,
                    is_anonymous: document.getElementById('anonymous').checked,
                    message: document.getElementById('donor-message').value,
                })
            });
            
            const { client_secret } = await response.json();
            
            // Confirm payment with Stripe
            const { error } = await stripe.confirmCardPayment(client_secret, {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById('donor-name').value,
                        email: document.getElementById('donor-email').value,
                    }
                }
            });
            
            if (error) {
                showError(error.message);
            } else {
                showSuccess('Thank you! Your donation has been processed successfully. You will receive a confirmation email shortly.');
            }
            
        } catch (error) {
            showError('Payment processing failed. Please try again.');
            console.error('Payment error:', error);
        }
    }
    
    async function processMobilePayment() {
        try {
            const response = await fetch('/process-mobile-payment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    amount: selectedAmount,
                    donor_name: document.getElementById('donor-name').value,
                    donor_email: document.getElementById('donor-email').value,
                    mobile_provider: document.getElementById('mobile-provider').value,
                    mobile_number: document.getElementById('mobile-number').value,
                    frequency: document.querySelector('input[name="frequency"]:checked').value,
                    is_anonymous: document.getElementById('anonymous').checked,
                    message: document.getElementById('donor-message').value,
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess(`
                    Payment request sent! Please check your phone for SMS instructions to complete the payment.
                    <br><br>
                    <strong>Reference:</strong> ${result.reference}
                    <br>
                    You will receive a confirmation email once payment is completed.
                `);
            } else {
                showError(result.message || 'Mobile payment failed. Please try again.');
            }
            
        } catch (error) {
            showError('Mobile payment processing failed. Please try again.');
            console.error('Mobile payment error:', error);
        }
    }
    
    async function processBankTransfer() {
        try {
            const response = await fetch('/process-bank-transfer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    amount: selectedAmount,
                    donor_name: document.getElementById('donor-name').value,
                    donor_email: document.getElementById('donor-email').value,
                    bank_name: document.getElementById('bank-name').value,
                    frequency: document.querySelector('input[name="frequency"]:checked').value,
                    is_anonymous: document.getElementById('anonymous').checked,
                    message: document.getElementById('donor-message').value,
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess(`
                    Bank transfer instructions sent to your email!
                    <br><br>
                    <strong>Reference:</strong> ${result.reference}
                    <br><br>
                    Please complete the transfer using the details provided in your email.
                    Your donation will be confirmed once we receive the transfer.
                `);
            } else {
                showError(result.message || 'Bank transfer setup failed. Please try again.');
            }
            
        } catch (error) {
            showError('Bank transfer processing failed. Please try again.');
            console.error('Bank transfer error:', error);
        }
    }
    
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // Initialize Stripe Elements for card payments
    if (window.STRIPE_PUBLIC_KEY && typeof Stripe !== 'undefined') {
        const stripe = Stripe(window.STRIPE_PUBLIC_KEY);
        const elements = stripe.elements();
        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#333',
                    '::placeholder': {
                        color: '#aab7c4',
                    },
                },
            },
        });
        
        cardElement.mount('#card-element');
        
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
                displayError.style.color = '#c33';
            } else {
                displayError.textContent = '';
            }
        });
        
        // Make cardElement available globally for form submission
        window.cardElement = cardElement;
    }
    
    // Auto-focus on first input
    document.getElementById('donor-name').focus();
    
    // Add smooth scrolling for better UX
    function scrollToError() {
        const errorElement = document.querySelector('.form-error');
        if (errorElement) {
            errorElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
    }
    
    // Add real-time form validation
    const requiredInputs = document.querySelectorAll('input[required], select[required]');
    requiredInputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.style.borderColor = '#f56565';
            } else {
                this.style.borderColor = '#e1e5e9';
            }
        });
        
        input.addEventListener('input', function() {
            if (this.value.trim()) {
                this.style.borderColor = '#48bb78';
            }
        });
    });
    
    // Format mobile number input
    const mobileInput = document.getElementById('mobile-number');
    mobileInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.startsWith('232')) {
            this.value = value;
        } else if (value.startsWith('0')) {
            this.value = '232' + value.substring(1);
        } else if (value.length > 0) {
            this.value = '232' + value;
        }
    });
    
    // Add loading states for dynamic content
    const loadingStates = {
        show: function(element) {
            element.style.opacity = '0.6';
            element.style.pointerEvents = 'none';
        },
        hide: function(element) {
            element.style.opacity = '1';
            element.style.pointerEvents = 'auto';
        }
    };
});
</script>
{% endblock %}